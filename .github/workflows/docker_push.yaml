name: Publish Docker image  
on:   
  push:
    branches:  
      - 'master'
    tags:       
      - '*'
jobs: 

  push_to_registry:  
    name: Push Docker image to Docker Hub
    runs-on: ubuntu-latest   

    steps:  
      - name: Check out the repo
        uses: actions/checkout@v2   

      - name: Log in to Docker Hub
        run: docker login --username=shw0n0 --password=snsdSNSD1028
      - name: Build and push Docker image
        run: |
          docker build -t shw0n0/getting-test:latest .
          docker push shw0n0/getting-test
            
      - name: Checkout Helm repository      
        uses: actions/checkout@v2
        with:
          repository: ShawnYang-95/helm-charts
          ref: master
          path: todo

          
      - name: Update image version in value.yaml
        run: |
          cd todo
          sed -i '/frontend:/,/service:/s/\(tag:\s*\).*/\1latestes/' values.yaml
          git config --global user.email "${{ github.actor }}[bot]@users.noreply.github.com"
          git config --global user.name "${{ github.actor }}"
          git add values.yaml
          git commit -m "Update image version to latest"
          git remote set-url origin https://x-access-token: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@github.com/ShawnYang-95/helm-charts.git
          git push origin master
      
      
#       - uses: GuillaumeFalourd/git-commit-push@v1.3
#         with:
#           target_branch: master
#           files: todo/values.yaml
#           commit_message: your_message
#           remote_repository: https://github.com/ShawnYang-95/helm-charts
#           access_token: ${{ secrets.GITHUB_TOKEN }}
#           force: true
#           empty: true



